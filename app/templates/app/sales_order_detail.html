{% extends 'app/base.html' %}
{% load humanize %}

{% block title %}Detail Order: {{ order.customer_name }}{% endblock %}

{% block content %}
<a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary mb-3">
    &larr; Kembali ke Dashboard Sales
</a>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">Order: {{ order.customer_name }} ({{ order.sku.sku_id }})</h1>
        <div>
            <button type="button" class="btn btn-sm btn-success me-2" onclick="printInvoiceA4({{ order.id }})">
                <i class="bi bi-receipt"></i> Print Invoice
            </button>

            <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="printOrderPdf({{ order.id }})">
                <i class="bi bi-printer"></i> Print Data Customer
            </button>

            {% if order.status == 'Sold' or order.status == 'Shipped' or order.status == 'Completed' %}
            <span class="badge bg-success fs-6">{{ order.get_status_display }}</span>
            {% elif order.status == 'Booked' %}
            <span class="badge bg-info text-dark fs-6">{{ order.get_status_display }}</span>
            {% else %}
            <span class="badge bg-warning text-dark fs-6">{{ order.get_status_display }}</span>
            {% endif %}
            <span class="badge bg-dark fs-6">{{ order.sku.get_status_display }}</span>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h5 class="h6">Data Customer</h5>
                <ul class="list-unstyled">
                    <li><strong>Nama:</strong> {{ order.customer_name }}</li>
                    <li><strong>Telepon:</strong> {{ order.customer_phone }}</li>
                    <li><strong>Alamat:</strong> {{ order.customer_address }}</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h5 class="h6">Data SKU</h5>
                <ul class="list-unstyled">
                    <li><strong>SKU ID:</strong> {{ order.sku.sku_id }}</li>
                    <li><strong>Nama Mesin:</strong> {{ order.sku.name }}</li>
                    <li><strong>Pengiriman:</strong> {{ order.shipping_type|default:"-" }}</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h5 class="h6">Data Keuangan</h5>
                <ul class="list-unstyled">
                    <li><strong>Harga Jual:</strong> Rp {{ order.price|intcomma }}</li>
                    <li><strong>Total Terbayar:</strong> Rp {{ total_paid|intcomma }}</li>
                    <li class="{% if remaining_balance > 0 %}text-danger{% else %}text-success{% endif %} h5">
                        <strong>Sisa Tagihan:</strong> Rp {{ remaining_balance|intcomma }}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
</div>

{% endblock %}

{% block extrascripts %}
<script>
    // Fungsi baru untuk memicu Invoice A4 (URL ini harus ada di urls.py)
    function printInvoiceA4(orderId) {
        const url = `/sales/order/${orderId}/print_invoice/`;
        window.open(url, '_blank');
    }

    // Fungsi lama untuk Data Customer 10x15
    function printOrderPdf(orderId) {
        const url = `/sales/order/${orderId}/print_label/`;
        window.open(url, '_blank');
    }

    // LOGIKA AUTO-PRINT KETIKA PAGE DIBUKA DENGAN ?print=true
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = {{ order.id }}; // Ambil Order ID dari konteks Django

        if (urlParams.get('print') === 'true') {

            // 1. Panggil fungsi cetak Invoice A4
            printInvoiceA4(orderId);

            // 2. Hapus parameter query string agar page tidak mencetak ulang saat di-refresh
            const newUrl = window.location.pathname;
            window.history.replaceState(null, '', newUrl);

            // 3. Tampilkan pesan konfirmasi (Opsional)
            console.log("Invoice A4 dicetak otomatis.");
        }
    });
</script>
{% endblock extrascripts %}