{% extends 'app/base.html' %}
{% load humanize %}

{% block title %}Quotation: {{ quotation.customer_name }}{% endblock %}

{% block content %}
<a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary mb-3">
    <i class="bi bi-arrow-left me-1"></i> Kembali ke Sales Dashboard
</a>

<div class="card card-glossy shadow-lg mb-4">

    <div class="card-header card-header-professional text-white d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0"><i class="bi bi-file-text me-2"></i> Quotation: {{ quotation.customer_name }} (Q#{{ quotation.quotation_number|default:quotation.id }})</h1>

        <div class="text-end">
            <button type="button" class="btn btn-sm btn-light text-primary me-2 shadow-sm" onclick="printQuotationA4({{ quotation.id }})">
                <i class="bi bi-printer"></i> Print Quotation A4
            </button>
            <span class="badge bg-light text-dark fs-6 py-2 px-3">{{ quotation.get_status_display }}</span>
        </div>
    </div>

    <div class="card-body p-4 p-md-5">
        <div class="row g-4">

            <div class="col-md-6 border-end">
                <h5 class="h6 fw-bold text-secondary mb-3"><i class="bi bi-info-circle me-1"></i> Informasi Quotation</h5>
                <ul class="list-unstyled small mb-4">
                    <li><strong>Nomor Quote:</strong> <span class="fw-bold text-dark">{{ quotation.quotation_number|default:"-" }}</span></li>
                    <li><strong>Tanggal Dibuat:</strong> {{ quotation.date|date:"d M Y" }}</li>
                    <li><strong>Berlaku Sampai:</strong> <span class="text-danger fw-bold">{{ quotation.valid_until|date:"d M Y"|default:"-" }}</span></li>
                    <li><strong>Sales Person:</strong> {{ quotation.sales_person.username }}</li>
                </ul>

                <h5 class="h6 fw-bold text-secondary mb-3"><i class="bi bi-person-badge me-1"></i> Data Customer</h5>
                <ul class="list-unstyled small">
                    <li><strong>Nama:</strong> {{ quotation.customer_name }}</li>
                    <li><strong>Telepon:</strong> {{ quotation.customer_phone }}</li>
                    <li><strong>Alamat:</strong> {{ quotation.customer_address }}</li>
                </ul>
            </div>

            <div class="col-md-6">
                <h5 class="h6 fw-bold text-secondary mb-3"><i class="bi bi-box-seam me-1"></i> Detail Produk</h5>
                <div class="row">
                    <div class="col-6">
                        <ul class="list-unstyled small">
                            <li><strong>SKU ID:</strong> <span class="fw-bold">{{ quotation.sku.sku_id }}</span></li>
                            <li><strong>Nama Mesin:</strong> {{ quotation.sku.name }}</li>
                            <li><strong>Status Mesin:</strong> <span class="badge bg-secondary">{{ quotation.sku.get_status_display }}</span></li>
                            <li><strong>Jumlah Unit:</strong> <span class="fw-bold text-primary">{{ quotation.quantity }}</span></li>
                        </ul>
                    </div>
                    <div class="col-6">
                        <h5 class="h6 fw-bold text-secondary mb-3">Rincian Biaya</h5>
                        <ul class="list-unstyled small">
                            <li><strong>Harga per Unit:</strong> Rp {{ quotation.price|intcomma }}</li>
                            <li><strong>Subtotal:</strong> Rp {{ quotation.get_subtotal|intcomma }}</li>
                            <li class="text-danger"><strong>Extra Discount:</strong> Rp {{ quotation.extra_discount|intcomma }}</li>
                        </ul>
                    </div>
                </div>

                <hr class="my-4">

                <div class="p-3 text-center bg-light border rounded">
                    <h4 class="text-primary mb-1">
                        TOTAL QUOTATION:
                    </h4>
                    <span class="fs-2 fw-bold text-success">
                        Rp {{ quotation.get_total_quote|intcomma }}
                    </span>
                </div>
            </div>
        </div>

        <hr class="my-4">
        <div class="d-flex justify-content-end gap-3">
            {% if quotation.status == 'Draft' or quotation.status == 'Sent' or quotation.status == 'Accepted' %}
            {# Tombol konversi akan aktif jika statusnya Draft, Sent, atau Accepted #}
            <form method="POST" action="{% url 'convert_to_order' quotation.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success shadow-sm">
                    <i class="bi bi-arrow-repeat me-1"></i> Konversi menjadi Sales Order
                </button>
            </form>
            {% elif quotation.status == 'Converted' %}
            <a href="{% url 'sales_order_detail' quotation.converted_to_order.id %}" class="btn btn-primary shadow-sm" title="Lihat Order">
                <i class="bi bi-cart-check me-1"></i> Sudah Dikonversi ke Order #{{ quotation.converted_to_order.id }}
            </a>
            {% else %}
            <button type="button" class="btn btn-secondary shadow-sm" disabled>
                <i class="bi bi-slash-circle me-1"></i> Konversi Tidak Tersedia
            </button>
            {% endif %}
        </div>

        <div class="card-footer bg-light border-top-0 py-3 text-end">
            <small class="text-muted">Dibuat: {{ quotation.created_at|date:"d M Y, H:i" }}</small>
        </div>
    </div>
{% endblock %}

{% block extrascripts %}
<script>
    function printQuotationA4(quotationId) {
        const url = `/sales/quotation/${quotationId}/print_a4/`;
        window.open(url, '_blank');
    }

    // LOGIKA AUTO-PRINT KETIKA PAGE DIBUKA DENGAN ?print=true
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const quotationId = {{ quotation.id }}; // Ambil Quotation ID dari konteks Django

        if (urlParams.get('print') === 'true') {

            // 1. Panggil fungsi cetak Quotation A4
            printQuotationA4(quotationId);

            // 2. Hapus parameter query string agar page tidak mencetak ulang saat di-refresh
            const newUrl = window.location.pathname;
            window.history.replaceState(null, '', newUrl);

            // 3. Tampilkan pesan konfirmasi (Opsional)
            console.log("Quotation A4 dicetak otomatis.");
        }
    });
</script>
{% endblock extrascripts %}