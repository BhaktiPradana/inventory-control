{% extends 'app/base.html' %}

{% block title %}Buat Purchase Order Baru{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 col-lg-8 mx-auto">
        <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary mb-3">
            <i class="bi bi-arrow-left me-1"></i> Kembali ke Dashboard Purchasing
        </a>

        <div class="card card-glossy shadow-lg">
            <div class="card-header card-header-professional text-white" style="background-color: #a569bd;">
                <h1 class="h4 mb-0"><i class="bi bi-file-earmark-plus me-2"></i> Buat Purchase Order (PO) Baru</h1>
            </div>

            <div class="card-body p-4 p-md-5">
                <p class="text-muted mb-4 small">
                    <i class="bi bi-info-circle me-1 text-primary"></i> PO yang dibuat di sini akan dikirim ke Warehouse Manager untuk approval.
                </p>

                <form method="POST" id="poCreationForm">
                    {% csrf_token %}

                    <h2 class="h5 mb-4 text-secondary"><i class="bi bi-list-ul me-1"></i> Detail Order Pembelian</h2>

                    {# 1. NOMOR PO (MANUAL RENDER) #}
                    <div class="mb-3">
                        <label for="{{ form.po_number.id_for_label }}" class="form-label fw-bold">{{ form.po_number.label }}</label>
                        {{ form.po_number }}
                        {% if form.po_number.errors %}<div class="text-danger small">{{ form.po_number.errors }}</div>{% endif %}
                    </div>

                    {# 2. JUMLAH SKU DIHARAPKAN (MANUAL RENDER - PENTING SEBAGAI TRIGGER) #}
                    <div class="mb-3">
                        <label for="{{ form.expected_sku_count.id_for_label }}" class="form-label fw-bold">{{ form.expected_sku_count.label }}</label>
                        {# Atribut ID, class, dan min sudah diset di forms.py, jadi cukup panggil field-nya #}
                        {{ form.expected_sku_count }}
                        {% if form.expected_sku_count.errors %}<div class="text-danger small">{{ form.expected_sku_count.errors }}</div>{% endif %}
                    </div>

                    {# --- START: TABEL DETAIL SKU (Hidden secara default) --- #}

                    <div id="sku-detail-section" style="display:none;">
                        <h2 class="h5 mt-5 mb-3 text-secondary border-top pt-3"><i class="bi bi-gear-fill me-1"></i> Detail SKU Mesin ( <span id="sku-count-display">0</span> Unit )</h2>

                        <div class="table-responsive">
                            <table class="table table-bordered table-sm align-middle" id="sku-detail-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 1%;">No.</th>
                                        <th>SKU ID Mesin*</th>
                                        <th>Nama Mesin*</th>
                                        <th>Warna*</th>
                                        <th style="width: 10%;">Tahun (Opsional)</th>
                                        <th>Harga PO per Unit (Rp)*</th>
                                    </tr>
                                </thead>
                                <tbody id="sku-detail-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {# --- END: TABEL DETAIL SKU --- #}

                    {# 3. TOTAL PO PRICE (MANUAL RENDER - AUTO-FILL) #}
                    <div class="mb-3">
                        <label for="id_total_po_price" class="form-label fw-bold">Total PO (Rp)</label>
                        {# Field ini harus memiliki ID id_total_po_price, sudah dijamin di forms.py #}
                        {{ form.total_po_price }}
                        <small class="text-muted">Nilai ini dihitung otomatis dari total harga PO di atas.</small>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-lg shadow" style="background-color: #a569bd; color: white;"
                                id="submitPOForm">
                            <i class="bi bi-send me-2"></i> Kirim PO ke Warehouse Manager
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        const poForm = document.getElementById('poCreationForm');
        const submitButton = document.getElementById('submitPOForm');

        const expectedSkuCountField = document.getElementById('id_expected_sku_count');
        const skuDetailSection = document.getElementById('sku-detail-section');
        const skuDetailTbody = document.getElementById('sku-detail-tbody');
        const totalPoPriceField = document.getElementById('id_total_po_price');

        // Fungsi Kalkulasi Total PO
        function calculateTotalPO() {
            let total = 0;
            const priceInputs = document.querySelectorAll('.po-price-input');
            priceInputs.forEach(input => {
                const price = parseFloat(input.value) || 0;
                total += price;
            });
            totalPoPriceField.value = total.toFixed(0);
            totalPoPriceField.dispatchEvent(new Event('change'));
        }

        // Fungsi Validasi Detail SKU
        function isSkuDetailsValid(skuCount) {
            let isValid = true;
            let totalFilled = 0;

            for (let i = 0; i < skuCount; i++) {
                const skuIdInput = document.getElementById(`sku_id_${i}`);
                const nameInput = document.getElementById(`name_${i}`);
                const colorInput = document.getElementById(`color_${i}`);
                const priceInput = document.getElementById(`price_${i}`);

                if (skuIdInput && nameInput && colorInput && priceInput) {
                    const priceValue = parseFloat(priceInput.value);

                    // Validasi Wajib Isi (*)
                    if (skuIdInput.value.trim() === '' ||
                        nameInput.value.trim() === '' ||
                        colorInput.value.trim() === '' ||
                        isNaN(priceValue) || priceValue <= 0) {

                        alert(`Detail SKU ke-${i + 1} belum lengkap. Semua field bertanda (*) wajib diisi, dan Harga PO harus angka positif.`);
                        skuIdInput.focus();
                        isValid = false;
                        break;
                    }

                    totalFilled++;
                } else if (skuCount > 0) {
                    isValid = false;
                    console.error(`Error: Element for SKU index ${i} not found.`);
                    alert(`Error: Kolom SKU gagal dimuat. Harap masukkan Jumlah SKU kembali.`);
                    break;
                }
            }

            if (isValid && totalFilled !== skuCount) {
                isValid = false;
                alert(`Jumlah baris detail (${totalFilled}) tidak sesuai dengan Jumlah SKU Diharapkan (${skuCount}).`);
            }

            calculateTotalPO();
            return isValid;
        }

        // Fungsi untuk me-render baris input detail SKU
        function renderSkuDetailFields(count) {
            const targetCount = parseInt(count) || 0;
            const currentCount = skuDetailTbody.children.length;

            if (targetCount > 0) {
                skuDetailSection.style.display = 'block';
                document.getElementById('sku-count-display').textContent = targetCount;
            } else {
                skuDetailSection.style.display = 'none';
                document.getElementById('sku-count-display').textContent = 0;
            }

            // Hapus baris yang berlebihan
            while (skuDetailTbody.children.length > targetCount) {
                skuDetailTbody.removeChild(skuDetailTbody.lastChild);
            }

            // Tambah baris baru
            for (let i = currentCount; i < targetCount; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}.</td>
                    <td>
                        <input type="text" name="sku_details[${i}][machine_sku_id]" id="sku_id_${i}" class="form-control form-control-sm sku-id-input" required>
                    </td>
                    <td>
                        <input type="text" name="sku_details[${i}][machine_name]" id="name_${i}" class="form-control form-control-sm machine-name-input" required>
                    </td>
                    <td>
                        <input type="text" name="sku_details[${i}][color]" id="color_${i}" class="form-control form-control-sm color-input" required>
                    </td>
                    <td>
                        <input type="number" name="sku_details[${i}][year]" id="year_${i}" class="form-control form-control-sm year-input" min="1900">
                    </td>
                    <td>
                        <input type="number" name="sku_details[${i}][po_price]" id="price_${i}" class="form-control form-control-sm po-price-input text-end" min="0" required step="1000">
                    </td>
                `;
                skuDetailTbody.appendChild(row);

                row.querySelector('.po-price-input').addEventListener('input', calculateTotalPO);
            }

            calculateTotalPO();
        }

        // --- PENTING: Pemicu saat load dan input berubah ---
        if (expectedSkuCountField) {

            // 1. Panggil saat DOMContentLoaded (jika form di-load dengan nilai)
            const initialValue = parseInt(expectedSkuCountField.value) || 0;
            renderSkuDetailFields(initialValue);

            // 2. Listener untuk perubahan nilai input
            expectedSkuCountField.addEventListener('input', function () {
                const inputValue = parseInt(this.value) || 0;
                if (inputValue >= 0) {
                    renderSkuDetailFields(inputValue);
                } else {
                    this.value = 0;
                    renderSkuDetailFields(0);
                }
            });
        }


        // --- LOGIKA SUBMIT ---
        poForm.addEventListener('submit', function (e) {
            e.preventDefault();

            if (!expectedSkuCountField) {
                alert("Fatal Error: Field 'Jumlah SKU Diharapkan' tidak ditemukan. Cek forms.py.");
                return;
            }

            const skuCount = parseInt(expectedSkuCountField.value) || 0;

            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-send me-2"></i> Kirim PO ke Warehouse Manager';

            // Validasi detail SKU
            if (skuCount > 0 && !isSkuDetailsValid(skuCount)) {
                return;
            }

            // Final check sebelum kirim
            calculateTotalPO();

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Mengirim PO...';

            poForm.submit();
        });
    });
</script>
{% endblock %}